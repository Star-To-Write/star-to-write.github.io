<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Star To Write</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
    />
    <link rel="stylesheet" href="/css/styles.css" />
  </head>
  <body>
    <nav class="bg-white border-bottom py-4 position-relative nav-scroll">
      <div class="container">
        <div
          class="container-fluid d-flex align-items-center justify-content-between position-relative"
        >
          <!-- Hamburger -->
          <button class="navbar-toggler toggleHamburger" id="menuToggle">
            <span class="bar"></span>
            <span class="bar"></span>
            <span class="bar"></span>
          </button>

          <!-- Logo / Heading -->
          <h2 class="position-absolute top-50 start-50 translate-middle m-0">
            <a class="text-black text-decoration-none" href="/"
              >STAR TO WRITE</a
            >
          </h2>
        </div>
        <!-- Hidden Menu -->
        <div class="collapse navbar-collapse" id="navMenu">
          <ul
            class="nav-links d-flex flex-column flex-md-row align-items-start gap-2 gap-md-4 mt-4 mb-2 mb-md-0 ps-1"
          >
            <li class="nav-item">
              <a class="nav-link" href="/">Star to Write</a>
            </li>
            <li class="nav-item">
              <a class="nav-link text-black" href="meet-the-team"
                >Meet the Team</a
              >
            </li>
            <li class="nav-item position-relative">
              <a class="nav-link" href="#" id="submissionsToggle"
                >Submissions
                <!-- svg for down arrow-->
                <!-- TODO: when expanding submissions tab, unhighlight star to write and highlight submissions. -->
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <polyline points="6 9 12 15 18 9" />
                </svg>
              </a>
              <div
                class="collapse position-absolute bg-white border border-shadow mt-2 start-0 navbar-collapse px-4"
                id="subsList"
                style="z-index: 1000; min-width: 200px"
              >
                <ul
                  class="nav-links d-flex flex-column flex-md-row align-items-start gap-4 mt-4 mb-2 mb-md-0"
                >
                  <!-- BUG: No highlight when on dynamic page -->
                  <li class="nav-item">
                    <a class="nav-link" href="/poetry">Published Poetry</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="/short-stories"
                      >Published Short Stories</a
                    >
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="/essays-opinions-research-papers"
                      >Published Essays, Opinions, and Research Papers</a
                    >
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="/writing-to-spread-awareness"
                      >Writing to Spread Awareness</a
                    >
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="other-creative-works"
                      >Other Creative Works</a
                    >
                  </li>
                </ul>
              </div>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/issues">Issues</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/interviews">Interviews</a>
            </li>
          </ul>
        </div>
      </div>

      <!-- nav men -->
    </nav>
    <div
      id="overlay"
      class="d-none position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-50"
      style="z-index: 1040"
    ></div>

    <!-- Hero -->
    <div
      class="container-fluid align-items-center text-center justify-content-center text-center p-0 pt-5"
    >
      <img
        src="/images/meet-the-team-bg.png"
        alt="Star To Write"
        {}
        class="w-100 object-fit-cover"
        style="height: 80px"
      />
    </div>

    <div class="container mt-4" id="subs-list"></div>
    <div class="container d-none" id="sub-view">poop</div>

    <!-- WANT TO BE FEATURED SECTION -->
    <div
      class="container-fluid align-items-center text-center justify-content-center my-5 hero"
    >
      <h2 class="heading pt-3 fs-4">WANT TO BE FEATURED?</h2>
      <p class="desc px-2">Submissions are always open, apply now!</p>
      <a
        href="https://docs.google.com/forms/d/1ZNft-6skfuy8qzGLPV_sVOCjuCg7taxwSjWt385eazE/edit?usp=drivesdk"
        class="btn btn-outline-dark border border-dark border-2 rounded-0 px-3 py-2"
      >
        SUBMISSIONS FORM
      </a>
    </div>

    <script src="/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // parsing
      const pathParts = window.location.pathname.split("/").filter(Boolean);
      // /poetry/test will be ['poetry', 'test']
      const category = pathParts[0];
      const slug = pathParts[1];

      <!-- TODO: Check redundancy before commit -->
      const contentDiv = document.getElementById("subs-list");
      const pageTitle = document.getElementById("subs-list");

      // Helper to convert title to slug format for single post view
      function titleToSlug(title) {
        return title.trim().toLowerCase().replace(/\s+/g, "-");
      }

      // based on weebly MM/DD/YYYY HH:MM:SS am/pm
      function formatDate(date) {
        const month = date.getMonth() + 1;
        const day = date.getDate();
        const year = date.getFullYear();
        const hours = date.getHours();
        const minutes = date.getMinutes().toString().padStart(2, "0");
        const seconds = date.getSeconds().toString().padStart(2, "0");
        const ampm = hours >= 12 ? "PM" : "AM";
        const displayHours = hours % 12 || 12;

        return `${month}/${day}/${year} ${displayHours}:${minutes}:${seconds} ${ampm}`;
      }

      // Helper function to generate author section
      function generateAuthorSection(post) {
        const isAnonymous = post.author === "Anonymous Writer";

        if (isAnonymous) {
          return `
            <div>
              <h3 class="heading fs-4 mt-3">AUTHOR</h3>
              <p class="fw-bold desc">${post.author}</p>
            </div>
          `;
        }

        // Non-anonymous author
        let authorSection = `
          <div>
            <h3 class="heading fs-4 mt-3">AUTHOR</h3>
            <p class="fw-bold desc">
              ${post.author}
              ${post.author_socials ? `<br />${post.author_socials}` : ""}
            </p>
        `;

        // Add bio if it exists
        if (post.author_bio) {
          authorSection += `
            <h3 class="heading fs-4 mt-3">AUTHOR BIO</h3>
            <p class="desc">${post.author_bio}</p>
          `;
        }

        authorSection += `</div>`;
        return authorSection;
      }

      // Helper function to generate bibliography section
      function generateBibliographySection(post) {
        if (
          post.submission_type === "essays-opinions-research-papers" &&
          post.bibliography
        ) {
          return `
            <div>
              <h3 class="heading fs-4 mt-3">BIBLIOGRAPHY</h3>
              <div class="desc">${post.bibliography}</div>
            </div>
          `;
        }
        return "";
      }

      // create the comments + its nested replies
      function createComments(comment, allComments, depth = 1) {
        const replies = allComments.filter((c) => c.parent_id === comment.id);
        const replyHTML = replies
          .map((r) => createComments(r, allComments, depth + 1))
          .join("");
        // Reply button does not show when its depth is 3 (comment's comment's comment)
        const replyButtonHTML =
          depth < 3
            ? `<div class="d-flex justify-content-end mb-3">
               <button class="btn btn-sm reply-btn px-3 py-2">REPLY</button>
             </div>`
            : "";

        return `
          <div class="mb-3 ms-${(depth - 1) * 4}" data-comment-id="${
          comment.id
        }" data-depth="${depth}">
            <div class="comment-header bg-light rounded-top p-3 d-flex justify-content-between align-items-center">
              <strong>${comment.author}</strong>
              <span class="text-muted small">${formatDate(
                new Date(comment.created_at)
              )}</span>
            </div>
            <div class="comment-body bg-white rounded-bottom p-3" style="border-radius: 0 0 1rem 1rem !important;">
              <p class="mb-3">${comment.content}</p>
              ${replyButtonHTML}
              <div class="reply-form-container"></div>
              ${replyHTML}
            </div>
          </div>
        `;
      }

      // shows the reply submission form
      function showForm(form) {
        form.classList.remove("d-none", "opacity-0");
        form.classList.add("d-block", "opacity-100", "show");
      }

      function hideForm(form) {
        form.classList.remove("d-block", "opacity-100", "show");
        form.classList.add("d-none", "opacity-0");
      }

      // reply form for the comment
      function createReplyForm() {
        const form = document.createElement("form");
        form.className =
          "reply-form bg-light p-3 mt-2 mb-3 rounded d-none opacity-0";
        form.innerHTML = `
          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label class="form-label">Name (required)</label>
              <input type="text" name="name" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Email (not published)</label>
              <input type="email" name="email" class="form-control" required>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Comment</label>
            <textarea name="comment" rows="3" class="form-control" required></textarea>
          </div>
          <div class="d-flex justify-content-end">
            <button type="submit" class="reply-submit btn px-3 py-2">SUBMIT</button>
          </div>
        `;

        // TODO: add functionality
        form.addEventListener("submit", (e) => {
          e.preventDefault();
          alert("Form submitted!");
          location.reload();
        });

        return form;
      }

      function toggleReplyForm(formContainer) {
        const existingForm = formContainer.querySelector(".reply-form");

        if (existingForm) {
          // Toggle reply form
          if (existingForm.classList.contains("d-none")) {
            showForm(existingForm);
          } else {
            hideForm(existingForm);
          }
          return;
        }

        // Create new form if none exists
        const form = createReplyForm();
        formContainer.appendChild(form);
      }

      // Reply button functionality
      // this was such a brainfuck. - beware future developers
      function handleReplyClick(btn) {
        // find the parent comment element
        const commentEl = btn.closest("[data-comment-id]");
        if (!commentEl) return;

        const commentBody = commentEl.querySelector(".comment-body");
        if (!commentBody) return;

        // Find or create the form container
        let formContainer = commentBody.querySelector(".reply-form-container");
        if (!formContainer) {
          formContainer = document.createElement("div");
          formContainer.className = "reply-form-container";
          commentBody.appendChild(formContainer);
        }

        toggleReplyForm(formContainer);
      }

      function attachReplyHandlers() {
        document.querySelectorAll(".reply-btn").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            e.preventDefault();
            handleReplyClick(btn);
          });
        });
      }

      function renderComments(comments) {
        const topLevelComments = comments.filter((c) => c.parent_id === null);
        const commentsHTML = topLevelComments
          .map((c) => createComments(c, comments))
          .join("");

        return `
          <div id="comments" class="mt-5">
            ${commentsHTML}
          </div>
        `;
      }

      async function loadSubmissionsList(category) {
        try {
          const response = await fetch(
            `/api/getSubmissionsByType?type=${category}`
          );

          const posts_data = await response.json();

          if (!posts_data.length) {
            contentDiv.innerHTML = "<p>No posts found in this category.</p>";
            return;
          }

          function getFormattedDate(date) {
            let year = date.getFullYear();
            let month = (1 + date.getMonth()).toString().padStart(2, "0");
            let day = date.getDate().toString().padStart(2, "0");

            return month + "/" + day + "/" + year;
          }

          contentDiv.innerHTML = posts_data
            .map(
              (post) => `
            
        <div class="py-3">
          <span class="pe-3">${getFormattedDate(
            new Date(post.created_at)
          )}</span>
          <span>
            <a href="/${category}/${titleToSlug(post.title)}">${
                post.comments.length
              } COMMENTS</a>
          </span>
          <h2 class="fs-4">
            <a href="/${category}/${titleToSlug(post.title)}">${post.title}</a>
          </h2>
          <div class="text-center desc">
            <p>${post.content}</p>
          </div>
          ${generateAuthorSection(post)}
          ${generateBibliographySection(post)}
          <div class="fs-6">
            <span class="pe-3">
              <a href="/${category}/${titleToSlug(post.title)}">${
                post.comments.length
              } COMMENTS</a>
            </span>
            <i class="bi bi-share"></i>
            <span class="ps-2">SHARE</span>
          </div>
        </div>
      `
            )
            .join("");

          console.log(
            `Loaded ${posts_data.length} posts in category: ${category}`
          );
        } catch (err) {
          console.error(err);
          contentDiv.innerHTML = "<p>Error loading category.</p>";
        }
      }

      function loadOneSubmission(category, slug) {
        fetch(`/api/getSubmissionsByType?type=${category}`)
          .then((res) => res.json())
          .then((posts) => {
            const post = posts.find((p) => titleToSlug(p.title) === slug);
            if (!post) {
              pageTitle.textContent = "Post not found";
              contentDiv.innerHTML = "<p>Sorry, this post does not exist.</p>";
              return;
            }

            pageTitle.textContent = post.title;
            // another date formatting thing here because the comments and the submission uses different dating formats. this does MM/DD/YYYY
            function getFormattedDate(date) {
              let year = date.getFullYear();
              let month = (1 + date.getMonth()).toString().padStart(2, "0");
              let day = date.getDate().toString().padStart(2, "0");
              return month + "/" + day + "/" + year;
            }

            contentDiv.innerHTML = `
        <div class="py-3">
          <span class="pe-3">${getFormattedDate(
            new Date(post.created_at)
          )}</span>
          <span>
            <a href="#comments">${post.comments.length} COMMENTS</a>
          </span>
          <h2 class="fs-4">
            <a href="/${category}/${titleToSlug(post.title)}">${post.title}</a>
          </h2>
          <div class="text-center desc">
            <p>${post.content}</p>
          </div>
          ${generateAuthorSection(post)}
          ${generateBibliographySection(post)}
          <div class="fs-6">
            <span class="pe-3">
              <a href="#comments">${post.comments.length} COMMENTS</a>
            </span>
            <i class="bi bi-share"></i>
            <span class="ps-2">SHARE</span>
          </div>
          <hr>
          ${renderComments(post.comments)}
        </div>
      `;

            attachReplyHandlers();
          })
          .catch((err) => {
            console.error(err);
            pageTitle.textContent = "Error";
            contentDiv.innerHTML = "<p>Error loading post.</p>";
          });
      }

      // Decide which view to load
      if (!slug) {
        loadSubmissionsList(category);
      } else {
        loadOneSubmission(category, slug);
      }
    </script>
  </body>
</html>
